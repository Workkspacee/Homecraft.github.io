<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="/bill.css">
    <script>
    function updateGSTAndAmounts() {
        const stateValue = document.getElementById('stateSelect').value;
        const isGujarat = stateValue.startsWith('24'); // Gujarat

        const qtyInputs = document.querySelectorAll('input[name="qty[]"]');
        const rateInputs = document.querySelectorAll('input[name="q_rate[]"]');
        const gstPercentInputs = document.querySelectorAll('input[name="q_gst[]"]');
        const gstAmtInputs = document.querySelectorAll('input[name="gst_amount[]"]');
        const grandTotalInputs = document.querySelectorAll('input[name="grand_total[]"]');
        const gstDisplaySpans = document.querySelectorAll('.gst-display');

        let gstTotal = 0;
        let amountTotal = 0;
        let quantityTotal = 0;

        for (let i = 0; i < qtyInputs.length; i++) {
            const qty = parseFloat(qtyInputs[i].value) || 0;
            const rate = parseFloat(rateInputs[i].value) || 0;
            const gstPercent = parseFloat(gstPercentInputs[i].value) || 0;

            const base = qty * rate;
            let gstAmount = (base * gstPercent) / 100;
            let totalAmount = base + gstAmount;

            if (!isGujarat) {
                gstAmount *= 2;
                totalAmount = base + gstAmount;

                if (gstDisplaySpans[i]) {
                    gstDisplaySpans[i].textContent = `${gstPercent}% + ${gstPercent}% = ${gstPercent * 2}%`;
                }
            } else {
                if (gstDisplaySpans[i]) {
                    gstDisplaySpans[i].textContent = `${gstPercent}%`;
                }
            }

            gstAmtInputs[i].value = gstAmount.toFixed(2);
            grandTotalInputs[i].value = totalAmount.toFixed(2);

            gstTotal += gstAmount;
            amountTotal += totalAmount;
            quantityTotal += qty;
        }

        // Update total fields
        const gstTotalField = document.getElementById('gst_total');
        const amountTotalField1 = document.querySelector('input[name="amount"]');
        const amountTotalField2 = document.getElementById('amount_total');
        const amountTotalSummary = document.getElementById('amount_total_summary');

        if (gstTotalField) gstTotalField.value = gstTotal.toFixed(2);
        if (amountTotalField1) amountTotalField1.value = amountTotal.toFixed(2);
        if (amountTotalField2) amountTotalField2.value = amountTotal.toFixed(2);
        if (amountTotalSummary) amountTotalSummary.value = amountTotal.toFixed(2);

        const qtyTotalInput = document.querySelector('input[name="quantity_total"]');
        if (qtyTotalInput) qtyTotalInput.value = quantityTotal.toFixed(2);

        updateFinalTotal();
        updateTaxBreakdown();
    }

    function updateFinalTotal() {
        const subTotal = parseFloat(document.getElementById('amount_total')?.value) || 0;
        const roundOff = parseFloat(document.getElementById('round_off')?.value) || 0;
        const final = subTotal + roundOff;
        const finalTotalInput = document.getElementById('final_total');
        if (finalTotalInput) finalTotalInput.value = final.toFixed(2);
    }

    function updateTaxBreakdown() {
        const state = document.getElementById('stateSelect').value;
        const qtyInputs = document.querySelectorAll('input[name="qty[]"]');
        const rateInputs = document.querySelectorAll('input[name="q_rate[]"]');
        const gstInputs = document.querySelectorAll('input[name="q_gst[]"]');

        const taxMap = {}; // Key: `${type}-${rate}`, Value: {taxable, taxAmt}
        const fullKey = (type, rate) => `${type}-${rate}`;

        for (let i = 0; i < qtyInputs.length; i++) {
            const qty = parseFloat(qtyInputs[i].value);
            const rate = parseFloat(rateInputs[i].value);
            const gst = parseFloat(gstInputs[i].value);

            if (!isNaN(qty) && !isNaN(rate) && !isNaN(gst)) {
                const taxable = qty * rate;

                if (state === '24') {
                    const halfRate = gst / 2;
                    const halfTax = (taxable * halfRate) / 100;

                    [['CGST', halfRate, halfTax], ['SGST', halfRate, halfTax]].forEach(([type, r, t]) => {
                        const key = fullKey(type, r);
                        if (!taxMap[key]) taxMap[key] = { type, rate: r, taxable: 0, taxAmt: 0 };
                        taxMap[key].taxable += taxable;
                        taxMap[key].taxAmt += t;
                    });
                } else {
                    const fullTax = (taxable * gst) / 100;
                    const halfRate = gst / 2;
                    const halfTax = (taxable * halfRate) / 100;

                    [['IGST', gst, fullTax], ['CGST', halfRate, halfTax], ['SGST', halfRate, halfTax]].forEach(([type, r, t]) => {
                        const key = fullKey(type, r);
                        if (!taxMap[key]) taxMap[key] = { type, rate: r, taxable: 0, taxAmt: 0 };
                        taxMap[key].taxable += taxable;
                        taxMap[key].taxAmt += t;
                    });
                }
            }
        }

        // Render breakdown table
        const tbody = document.getElementById('taxBreakdownBody');
        if (tbody) {
            tbody.innerHTML = '';
            Object.values(taxMap).forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.type}</td>
                    <td>${entry.taxable.toFixed(2)}</td>
                    <td>${entry.rate.toFixed(2)}%</td>
                    <td>${entry.taxAmt.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }
    }

    // Attach events
    document.addEventListener('DOMContentLoaded', () => {
        const inputs = document.querySelectorAll('input[name="qty[]"], input[name="q_rate[]"], input[name="q_gst[]"]');
        inputs.forEach(input => input.addEventListener('input', updateGSTAndAmounts));

        document.getElementById('stateSelect').addEventListener('change', updateGSTAndAmounts);
        document.getElementById('round_off').addEventListener('input', updateFinalTotal);

        // Initial calculation
        updateGSTAndAmounts();
    });
    </script>


</head>
<body>

    <!-- <div class="header1">
        <nav>
            <img src="/logo.png" alt="logo">
            <h3><a href="/logout">Log out</a></h3>
        </nav>
    </div> -->

    <div class="container">
        <table class="info" style="width:100%">
            <tr>
                <td>
                    <img src="/logo.png" alt="logo" height="120px">
                </td>
                <td align="right">
                    <h2>Homecraft</h2>
                    <p>Plot No. 521, Road No. 5, Near Paliwal Chowkdi, GIDC Sachin, Surat - 394230</p>
                    <p>Phone no.: +91-9328282823</p>
                    <p>GSTIN: 24ARFPR5413C1Z5, State: 24-Gujarat</p>
                </td>
            </tr>
        </table>

        <br>
        <center><h3>Tax Invoice</h3></center> 
        <br>
        <br>
        
        <form action="/bill" method="post">
            <nav class="details" style="display: flex; flex: 1 1 22%; min-width: 250px; justify-content: space-between; align-items: center;"> 
                <div style="padding-right: 20px;">
                    <h4>Bill To</h4><br>
                    <input type="text" class="input_field" placeholder="Name" name="name" value="<%= no.name %>" style="font-weight: 700;" />
                    <br>
                    <textarea name="add" cols="20"  placeholder="Address"><%= no.add %></textarea><br>
                    <label>Contact No: <input type="tel" class="input_field" maxlength="10" name="p_no" value="<%= no.p_no %>"></label><br>
                    <label>State: 
                        <select name="state" id="stateSelect" required>
                            <option value="">-- Select State --</option>
                            <option value="01" <%= no.state === '01' ? 'selected' : '' %>>01 - Jammu and Kashmir</option>
                            <option value="02" <%= no.state === '02' ? 'selected' : '' %>>02 - Himachal Pradesh</option>
                            <option value="03" <%= no.state === '03' ? 'selected' : '' %>>03 - Punjab</option>
                            <option value="04" <%= no.state === '04' ? 'selected' : '' %>>04 - Chandigarh</option>
                            <option value="05" <%= no.state === '05' ? 'selected' : '' %>>05 - Uttarakhand</option>
                            <option value="06" <%= no.state === '06' ? 'selected' : '' %>>06 - Haryana</option>
                            <option value="07" <%= no.state === '07' ? 'selected' : '' %>>07 - Delhi</option>
                            <option value="08" <%= no.state === '08' ? 'selected' : '' %>>08 - Rajasthan</option>
                            <option value="09" <%= no.state === '09' ? 'selected' : '' %>>09 - Uttar Pradesh</option>
                            <option value="10" <%= no.state === '10' ? 'selected' : '' %>>10 - Bihar</option>
                            <option value="11" <%= no.state === '11' ? 'selected' : '' %>>11 - Sikkim</option>
                            <option value="12" <%= no.state === '12' ? 'selected' : '' %>>12 - Arunachal Pradesh</option>
                            <option value="13" <%= no.state === '13' ? 'selected' : '' %>>13 - Nagaland</option>
                            <option value="14" <%= no.state === '14' ? 'selected' : '' %>>14 - Manipur</option>
                            <option value="15" <%= no.state === '15' ? 'selected' : '' %>>15 - Mizoram</option>
                            <option value="16" <%= no.state === '16' ? 'selected' : '' %>>16 - Tripura</option>
                            <option value="17" <%= no.state === '17' ? 'selected' : '' %>>17 - Meghalaya</option>
                            <option value="18" <%= no.state === '18' ? 'selected' : '' %>>18 - Assam</option>
                            <option value="19" <%= no.state === '19' ? 'selected' : '' %>>19 - West Bengal</option>
                            <option value="20" <%= no.state === '20' ? 'selected' : '' %>>20 - Jharkhand</option>
                            <option value="21" <%= no.state === '21' ? 'selected' : '' %>>21 - Odisha</option>
                            <option value="22" <%= no.state === '22' ? 'selected' : '' %>>22 - Chhattisgarh</option>
                            <option value="23" <%= no.state === '23' ? 'selected' : '' %>>23 - Madhya Pradesh</option>
                            <option value="24" <%= no.state === '24' ? 'selected' : '' %>>24 - Gujarat</option>
                            <option value="25" <%= no.state === '25' ? 'selected' : '' %>>25 - Daman and Diu</option>
                            <option value="26" <%= no.state === '26' ? 'selected' : '' %>>26 - Dadra and Nagar Haveli</option>
                            <option value="27" <%= no.state === '27' ? 'selected' : '' %>>27 - Maharashtra</option>
                            <option value="28" <%= no.state === '28' ? 'selected' : '' %>>28 - Andhra Pradesh (Old)</option>
                            <option value="29" <%= no.state === '29' ? 'selected' : '' %>>29 - Karnataka</option>
                            <option value="30" <%= no.state === '30' ? 'selected' : '' %>>30 - Goa</option>
                            <option value="31" <%= no.state === '31' ? 'selected' : '' %>>31 - Lakshadweep</option>
                            <option value="32" <%= no.state === '32' ? 'selected' : '' %>>32 - Kerala</option>
                            <option value="33" <%= no.state === '33' ? 'selected' : '' %>>33 - Tamil Nadu</option>
                            <option value="34" <%= no.state === '34' ? 'selected' : '' %>>34 - Puducherry</option>
                            <option value="35" <%= no.state === '35' ? 'selected' : '' %>>35 - Andaman and Nicobar Islands</option>
                            <option value="36" <%= no.state === '36' ? 'selected' : '' %>>36 - Telangana</option>
                            <option value="37" <%= no.state === '37' ? 'selected' : '' %>>37 - Andhra Pradesh (New)</option>
                            <option value="38" <%= no.state === '38' ? 'selected' : '' %>>38 - Ladakh</option>
                        </select>
                    </label>

                    <br><br>
                </div>

                <div style="padding-right: 40px;">
                    <h4>Ship To</h4><br>
                    <!-- <textarea name="add" cols="20" rows="3" placeholder="Address"><%= no.add %></textarea> -->  
                    <br><br><br><br><br>
                </div>
                <div style="padding-right: 40px;">
                    <h4>Transportation Details</h4><br>
                    <label>Driver Name: <input type="text" name="driver_name" class="input_field" placeholder="Name"/></label><br>
                    <label>Vehicle Number: <input type="text" name="v_no"  class="input_field" placeholder="GJ05FR9362"/></label><br>
                    <label>Delivery Date: <input type="date" name="d_date"  class="input_field" placeholder="date" /></label><br>
                    <label>Location:<input type="text" name="loc"  class="input_field" placeholder="Surat"></label><br>
                    <label>LR Number: <input type="text"  name="lr_no" class="input_field"></label>
                    <br><br>
                </div>
                <div> 
                    <h4>Invoice Details</h4><br>
                    <label>Invoice No:<input type="text" name="work_no" class="input_field" value="<%= no.work_no %>" readonly></label><br>
                    <label>Date: <input type="date" name="d_date" class="input_field"></label><br>
                    <label>Place of supply:<input type="text"  name="supply_place" class="input_field"></label><br>
                    <label>Due Date: <input type="date"  name="due_date" class="input_field"></label>
                    <br><br><br><br>
                </div>
            </nav>

            <table class="bill table-hover table-bordered">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Item Name</th>
                        <th>HSN/SAC</th>
                        <th>Quantity</th>
                        <th>Unit</th>
                        <th>Price/Unit</th>
                        <th>GST</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <% selectedRows.forEach((q, index) => { %>
                        <tr>
                            <td class="sr-no"><%= index + 1 %></td>
                            <td><input type="text" step="any" class="bill_table" name="material[]" value="<%= q.material || '' %>" style="font-weight: bold;"></td>
                            <td><input type="text" step="any" class="bill_table" name="q_hsn[]" value="<%= q.q_hsn || '' %>" style="width: 100%;"></td>
                            <td><input type="number" step="any" class="bill_table qty" name="qty[]" value="<%= q.qty || '' %>" style="width: 100%;"></td>
                            <td>Mtr</td>.. 
                            <td><input type="number" step="any" class="bill_table q_rate" name="q_rate[]" value="<%= q.q_rate || '' %>" style="width: 100%;"></td>
                            <td><input type="hidden" step="any" class="bill_table" name="q_gst[]" value="<%= q.q_gst || '' %>" style="width: 100%;"><span class="gst-display"></span> RS ( )<input type="number" name="gst_amount[]" class="gst_amount bill_table" readonly></td>
                            <td><input type="number" step="any" class="bill_table grand_total" name="grand_total[]" value="<%= q.grand_total || '' %>" style="width: 100%;"></td>
                        </tr>
                    <% }) %>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td style="font-weight: bold;">Total</td>
                        <td></td>
                        <td><input type="number" step="any" class="bill_table" name="quantity_total" style="width: 100%;"></td>
                        <td></td>
                        <td></td>
                        <td><input type="number" step="any" class="bill_table" id="gst_total" name="gst_total" style="width: 100%;"></td>
                        <td><input type="number" step="any" class="bill_table" name="amount" id="amount_total" style="width: 100%;"></td>
                    </tr>  
                </tbody>
            </table><br>

            <div style="display: flex; align-items: flex-start; gap: 20px;">
                <table class="tax" id="taxBreakdownTable" style="width: 60%;">
                    <thead>
                        <tr>
                            <th>Tax Type</th>
                            <th>Taxable Amount</th>
                            <th>Rate</th>
                            <th>Tax Amount</th>
                        </tr>
                    </thead>
                    <tbody id="taxBreakdownBody">
                        
                    </tbody>
                </table>
                <table class="tax" style="width: 35%; min-width: 250px;">
                    <tbody>
                    <tr>
                        <td style="text-align: right;"><strong>Sub Total (₹):</strong></td>
                        <td><input type="number" id="amount_total_summary" name="amount_total" readonly class="form-control" style="width: 100%;" /></td>
                    </tr>
                    <tr>
                        <td style="text-align: right;"><strong>Round Off (₹):</strong></td>
                        <td><input type="number" id="round_off" name="round_off" step="any" class="form-control" style="width: 100%;" /></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; border-top: 2px solid black;"><strong>Final Total (₹):</strong></td>
                        <td><input type="number" id="final_total" name="final_total" readonly class="form-control" style="width: 100%; font-weight: bold;" /></td>
                    </tr>
                    </tbody>
                </table>
            </div>


            <table class="ivoice_words">
                <tr>
                    <th align="left"><h3>Invoice Amount In Words</h3></th>
                </tr>
                <tr></tr>
                <tr></tr><tr></tr>
                <tr>
                    <td>Thirty Nine Thousand Three Hundred Thirty Three Rupees only</td>
                </tr>
            </table><br>

            <table class="terms">
                <tr>
                    <td>
                        <h3>Terms and Conditions</h3>
                        <p>- We reserve the right of recovery before due date at any time.</p>
                        <p>- Goods once sold cannot be returned. Any defect in the material</p>
                        <p>received should be brought into notice withim the 48 hours of delivery.</p>
                        <p>- The sale is understood to have been made after due consideration of </p>
                        <p>the quality of goods and prevailing rates.</p>
                        <p>- The payment of this bill shall be made by the due date failing which interest</p>
                        <p>@ 1.5% Per Month shall be charged from the due date.</p>
                    </td>
                </tr>
            </table><br>

            <table style="width: 100%;">
                <tr>
                    <td>
                        <h3>Bank Details</h3><br>
                        <p>Name: HDFC BANK</p><br>
                        <p>Account No.: 50200023386178</p><br>
                        <p>IFSC code: HDFC0000955</p><br>
                        <p>Account holder's name: Homecraft</p><br>
                    </td>
                    <td>
                        <p>For: Homecraft</p>
                        <br><br><br>
                        <br><br>
                        <h3>Authorized Signatory</h3>
                    </td>
                </tr>
            </table><br>

            <center>
                <button type="submit" class="but">Submit</button>   
                <button type="button" class="but">Print</button>
            </center>
        </form>

    </div>

    <!-- <div class="footer">
        <nav>
            <p> &copy; 2024 All Rights Reserved.</p>
            <p>Designed with <i class="fas fa-heart" style="color:red"></i></p>
        </nav>
    </div> -->

</body>


</html>